<html>
<head>
  <!-- Standard Meta -->
  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">

  <!-- Site Properties -->
  <title>Screem</title>
  <link rel="stylesheet" type="text/css" href="semantic/dist/semantic.css">

  <link rel="shortcut icon" type="image/png" href="assets/pictures/steem.png"/>

  <script src="https://code.jquery.com/jquery-3.1.0.min.js"></script>
  <script src="steemjs-lib.min.js"></script>
  <script src="semantic/dist/semantic.js"></script>
  <script>

  $(document).ready(function(){
      $('.menu .item').tab();
  });

  </script>
  <style>
    .last.container {
      margin-bottom: 300px !important;
    }
    h1.ui.center.header {
      margin-top: 3em;
    }
    h2.ui.center.header {
      margin: 4em 0em 2em;
    }
    h3.ui.center.header {
      margin-top: 2em;
      padding: 2em 0em;
    }
  </style>
</head>
<body>
<div class="ui pointing borderless menu">
  <div class="item">
    <img src="assets/pictures/steemicon.png">
  </div>
    <a class="item active" data-tab="first">Discover</a>
    <a class="item" data-tab="second">Feed</a>
    <a class="item" data-tab="third">Followers</a>
  <div class="right menu">
    <div class="item">
      <div class="ui icon transparent large input">
        <input type="text" placeholder="Search" id="search">
        <i class="search link icon"></i>
      </div>
    </div>
    <a class="item" data-tab="fourth" id="loginButton" >Sign in</a>
  </div>
</div>

<script>
$("#search").keyup(function(event){
    if(event.keyCode == 13){ //enter key was pressed at search
    }
});

$("#statusbox").keyup(function(event){ /// NOT WORKING, MAKES ME ANGRY
    if(event.keyCode == 13){ //enter key was pressed at search
    }
});

var loggedIn=false;
var login = new window.steemJS.Login();
login.setRoles(["posting"]);
var posts = [];

const options = {
    // user: "username",
    // pass: "password",
    // url: "ws://127.0.0.1:8090",
    apis: ["database_api", "network_broadcast_api"],
    url: "wss://this.piston.rocks"
};
function steemlogin(){
  var username = document.getElementById("user").value;
  var password = document.getElementById("pass").value;
  var Api = window.steemJS.steemRPC.Client.get(options, true);
  Api.initPromise.then(function(res){
    Api.database_api().exec("get_accounts", [[username]]).then(function(res) {
      var account = res[0];
      try{
        let success = login.checkKeys({
            accountName: username,
            password: password,
            auths: {
                owner: account.owner.key_auths,
                active: account.active.key_auths,
                posting: account.posting.key_auths
            }});
            if(success){ // we're in.
              document.getElementById("errors").innerHTML = '<div class="ui green basic label">Success</div>';
              var atag = document.getElementById("loginButton");
              atag.parentNode.removeChild(atag);
              loggedIn=true;
            }
            else{ // user entered the wrong credentials.
              document.getElementById("errors").innerHTML = '<div class="ui red basic label">Error: Incorrect username or password</div>';
            }
        }
        catch(err){
          document.getElementById("errors").innerHTML = '<div class="ui red basic label">'.concat(err).concat('</div>');
        }
    });
  });
}

function vote(id){
  var username = document.getElementById("user").value;
  var password = document.getElementById("pass").value;
  if(loggedIn){
    $("#".concat(id).concat("card")).toggleClass("grey red");
    $("#".concat(id)).toggleClass("grey red");
    let tr = new window.steemJS.TransactionBuilder();
    console.log(posts[id][id]);
    tr.add_type_operation("vote", {
        voter: username,
        author: posts[id]['value'].split("/")[0],
        permlink: posts[id]['value'].split("/")[1],
        weight: 10000
    });
    tr.process_transaction(login, null, true);
  }
  else{
    $('#'.concat(id)).html("log in first");
  }
}


</script>

<div class="ui grid">
  <div class="two wide column"></div>
  <div class="twelve wide column">
    <div class="ui tab active" data-tab="first">
      <div class="ui fluid icon input grey" id="statusarea">
        <input type="text" placeholder="Tell us how you really feel" id="statusbox">
        <i class="send icon"></i>
      </div>
      <script>
      var id = 0;
      //var posts = [];

      $.getJSON( "https://api.steemjs.com/getState?path=/hot/funny", function( data ) {
        $.each( data['content'], function( key, val ) {
          posts.push({
            key: id,
            value: key
          });
          $(".discovertweets").append('\
          <div class="ui grey fluid card" id="'.concat(id).concat('card">\
            <div class="content">\
              <!--<img class="right floated mini ui image" src="assets/pictures/default_profile.png">-->\
              <button class="right floated ui grey mini icon button" id="').concat(id).concat('" onclick="vote(\'').concat(id).concat('\')"><i class="heart icon"></i></button>\
              <div class="header">\
              ').concat(val['author']).concat('\
              </div>\
              <div class="meta">\
                Posted 34 seconds ago.\
              </div>\
              <div class="description">\
          ').concat(val['title']).concat('\
          <div class="basic right floated label"><i class="dollar icon"></i>').concat(val['total_pending_payout_value']).concat('</div>\
          </div>\
          </div>\
          <!--<div class="extra content">\
          <div class="ui left floated labeled button" tabindex="0">\
            <!--<div class="ui grey mini button">\
              <i class="heart icon"></i>Like\
            </div>\
            <a class="ui basic grey left pointing label">\
          ').concat(val['net_votes']).concat('\
          </a>\
        </div>-->\
        </div>\
        </div>\
          '));
          id++;
        });
      });
      </script>
      <br />
      <div class="discovertweets">

      </div>
      <!--<div class="ui active centered inline loader"></div>-->
    </div>

    <div class="ui tab" data-tab="second">
      <div class="ui fluid card">
        <div class="content">
          Second
        </div>
      </div>
    </div>

    <div class="ui tab" data-tab="third">
      <div class="ui fluid card">
        <div class="content">
          Third
        </div>
      </div>
    </div>

    <div class="ui tab" data-tab="fourth">
      <div class="ui fluid card">
        <div class="content">
          <form class="ui form">
            <div class="field">
              <label>Username</label>
              <input type="text" id="user" placeholder="Username">
            </div>
            <div class="field">
              <label>Password</label>
              <input type="password" id="pass" placeholder="Password">
            </div>
            <div class="field">
              <div class="ui checkbox" id="errors">
              </div>
            </div>
            <button class="ui button" type="button" onclick="steemlogin()">Login</button>
          </form>
        </div>
      </div>
    </div>
  <div class="two wide column"></div>
</div>




</body>
</html>
